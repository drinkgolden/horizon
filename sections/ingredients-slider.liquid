{% comment %}
  DYNAMIC CAROUSEL — Vertical spines that expand into a rich media panel.
{% endcomment %}

{{ 'dynamic-carousel.css' | asset_url | stylesheet_tag }}

{% liquid
  assign aria_label = section.settings.accessibility_label | default: 'Dynamic carousel'

  assign height_style = ''
  if section.settings.section_height == 'custom'
    assign height_style = section.settings.section_height_custom | append: 'svh'
  elsif section.settings.section_height != blank
    assign height_style = 'var(--section-height-' | append: section.settings.section_height | append: ')'
  endif

  assign section_color_scheme = section.settings.section_color_scheme | default: 'scheme-1'

  assign has_footer = false
  if section.settings.footer_text != blank or section.settings.footer_link_label != blank
    assign has_footer = true
  endif

  assign interaction_mode = 'click'
  if section.settings.open_on_hover
    assign interaction_mode = 'hover'
  endif
%}

<section
  class="dynamic-carousel color-{{ section_color_scheme }}"
  aria-label="{{ aria_label | escape }}"
  style="{% if height_style != blank %}--dynamic-carousel-min-height: {{ height_style }};{% endif %}"
>
  <div class="page-width dynamic-carousel__container">
    {% if section.blocks.size > 0 %}
      <div
        class="dynamic-carousel__stage"
        data-dynamic-carousel-stage
        data-interaction-mode="{{ interaction_mode }}"
      >
        <div
          class="dynamic-carousel__rail"
          role="tablist"
          aria-label="{{ aria_label | escape }}"
          aria-orientation="horizontal"
          data-dynamic-carousel-rail
        >
          {% for block in section.blocks %}
            {% assign handle_id = 'DynamicCarouselTab-' | append: block.id %}
            {% assign panel_id = 'DynamicCarouselPanel-' | append: block.id %}
            {% assign is_active = forloop.first %}
            {% assign block_color_scheme = block.settings.color_scheme | default: section_color_scheme %}

            {% capture handle_styles %}
              --spine-background: var(--color-background);
              --spine-color: var(--color-foreground);
              --panel-background: var(--color-background);
              --panel-color: var(--color-foreground);
              {% if block.settings.spine_padding_block != blank %}
                --spine-padding-block: {{ block.settings.spine_padding_block }}px;
              {% endif %}
              {% if block.settings.spine_padding_inline != blank %}
                --spine-padding-inline: {{ block.settings.spine_padding_inline }}px;
              {% endif %}
              {% if block.settings.spine_alignment == 'start' %}
                --spine-justify:flex-start;
                --spine-align:flex-start;
              {% elsif block.settings.spine_alignment == 'end' %}
                --spine-justify:flex-end;
                --spine-align:flex-end;
              {% else %}
                --spine-justify:center;
                --spine-align:center;
              {% endif %}
            {% endcapture %}

            {% assign spine_text_style = block.settings.spine_text_style | default: 'h3' %}
            {% assign spine_text_class = 'dynamic-carousel__spine-text dynamic-carousel__spine-text--' | append: spine_text_style %}

            <button
              type="button"
              id="{{ handle_id }}"
              class="dynamic-carousel__spine color-{{ block_color_scheme }}{% if is_active %} is-active{% endif %}"
              role="tab"
              aria-controls="{{ panel_id }}"
              aria-selected="{% if is_active %}true{% else %}false{% endif %}"
              aria-expanded="{% if is_active %}true{% else %}false{% endif %}"
              tabindex="{% if is_active %}0{% else %}-1{% endif %}"
              data-dynamic-carousel-handle
              data-block-id="{{ block.id }}"
              style="{{ handle_styles | strip | replace: '  ', ' ' }}"
              {{ block.shopify_attributes }}
            >
              <span class="{{ spine_text_class }}">
                {{- block.settings.spine_heading | default: block.settings.heading | default: 'Slide heading' -}}
              </span>
            </button>
          {% endfor %}
        </div>

        <div class="dynamic-carousel__panels" data-dynamic-carousel-panels>
          {% for block in section.blocks %}
            {% assign handle_id = 'DynamicCarouselTab-' | append: block.id %}
            {% assign panel_id = 'DynamicCarouselPanel-' | append: block.id %}
            {% assign is_active = forloop.first %}
            {% assign block_color_scheme = block.settings.color_scheme | default: section_color_scheme %}

            {% capture panel_styles %}
              --panel-background: var(--color-background);
              --panel-color: var(--color-foreground);
            {% endcapture %}

            {% capture media_markup %}
              {% case block.settings.media_type %}
                {% when 'image' %}
                  {% if block.settings.image %}
                    {{ block.settings.image | image_url: width: 1800 | image_tag: widths: '480, 720, 960, 1200, 1600, 1800', sizes: '(min-width: 1200px) 40vw, (min-width: 750px) 60vw, 100vw', loading: 'lazy', class: 'dynamic-carousel__media-image', alt: block.settings.heading | default: block.settings.spine_heading }}
                  {% endif %}
                {% when 'uploaded_video' %}
                  {% if block.settings.video %}
                    {% render 'video', video: block.settings.video, video_autoplay: block.settings.video_autoplay, video_loop: block.settings.video_loop, video_class: 'dynamic-carousel__media-embed', section_id: section.id, block: block %}
                  {% endif %}
                {% when 'external_video' %}
                  {% if block.settings.video_url != blank %}
                    {% assign external_video = block.settings.video_url | video_url %}
                    {% render 'video', video_from_url: true, video: external_video.id, video_type: external_video.type, video_autoplay: block.settings.video_autoplay, video_loop: block.settings.video_loop, video_class: 'dynamic-carousel__media-embed', video_preview_image: block.settings.video_poster, video_alt: block.settings.heading | default: block.settings.spine_heading, section_id: section.id, block: block %}
                  {% endif %}
              {% endcase %}
            {% endcapture %}
            {% assign media_markup = media_markup | strip %}

            <section
              id="{{ panel_id }}"
              class="dynamic-carousel__panel color-{{ block_color_scheme }}{% if media_markup != blank %} dynamic-carousel__panel--with-media{% endif %}{% if is_active %} is-active{% endif %}"
              role="tabpanel"
              aria-labelledby="{{ handle_id }}"
              aria-hidden="{% unless is_active %}true{% else %}false{% endunless %}"
              data-dynamic-carousel-panel
              data-block-id="{{ block.id }}"
              style="{{ panel_styles | strip | replace: '  ', ' ' }}"
              {% unless is_active %}hidden{% endunless %}
            >
              <div class="dynamic-carousel__panel-inner{% if media_markup != blank %} dynamic-carousel__panel-inner--with-media{% endif %}">
                {% if media_markup != blank %}
                  <div class="dynamic-carousel__media">
                    {{ media_markup }}
                  </div>
                {% endif %}

                <div class="dynamic-carousel__content">
                  <div class="dynamic-carousel__content-header">
                    <div class="dynamic-carousel__titles">
                      {% if block.settings.eyebrow != blank %}
                        <p class="dynamic-carousel__eyebrow">{{ block.settings.eyebrow }}</p>
                      {% endif %}

                      {% if block.settings.heading != blank %}
                        <h3 class="dynamic-carousel__title">{{ block.settings.heading }}</h3>
                      {% endif %}

                      {% if block.settings.summary != blank %}
                        <p class="dynamic-carousel__summary">
                          {{- block.settings.summary | escape | newline_to_br -}}
                        </p>
                      {% endif %}
                    </div>

                    {% if block.settings.icon %}
                      <div class="dynamic-carousel__icon">
                        {{
                          block.settings.icon
                          | image_url: width: 140
                          | image_tag:
                            widths: '80, 120, 160',
                            loading: 'lazy',
                            alt: block.settings.icon_alt | default: ''
                        }}
                      </div>
                    {% endif %}
                  </div>

                  {% if block.settings.body != blank %}
                    <div class="dynamic-carousel__body">
                      {{ block.settings.body }}
                    </div>
                  {% endif %}

                  {% if block.settings.details != blank %}
                    <div class="dynamic-carousel__details">
                      {{ block.settings.details }}
                    </div>
                  {% endif %}

                  {% if block.settings.cta_label != blank and block.settings.cta_url != blank %}
                    <div class="dynamic-carousel__actions">
                      <a
                        href="{{ block.settings.cta_url }}"
                        class="button button--primary dynamic-carousel__button"
                      >
                        {{ block.settings.cta_label }}
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </section>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="dynamic-carousel__empty">
        {{ 'sections.general.no_content' | t: section_name: section.name }}
      </div>
    {% endif %}

    {% if has_footer %}
      <div class="dynamic-carousel__footer">
        {% if section.settings.footer_text != blank %}
          <div class="dynamic-carousel__footer-text">{{ section.settings.footer_text }}</div>
        {% endif %}

        {% if section.settings.footer_link_label != blank and section.settings.footer_link_url != blank %}
          <a class="dynamic-carousel__footer-link" href="{{ section.settings.footer_link_url }}">
            {{ section.settings.footer_link_label }}
            <span class="dynamic-carousel__footer-icon" aria-hidden="true">→</span>
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Dynamic Carousel",
  "settings": [
    {
      "type": "text",
      "id": "accessibility_label",
      "label": "Accessible label",
      "info": "Used by assistive technology in place of a visible heading."
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "Section height",
      "options": [
        {
          "value": "",
          "label": "Natural height"
        },
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        },
        {
          "value": "extra-large",
          "label": "Extra large"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "custom"
    },
    {
      "type": "range",
      "id": "section_height_custom",
      "label": "Custom height",
      "min": 40,
      "max": 100,
      "step": 1,
      "unit": "svh",
      "default": 60,
      "visible_if": "{{ section.settings.section_height == 'custom' }}"
    },
    {
      "type": "color_scheme",
      "id": "section_color_scheme",
      "label": "Section color scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "open_on_hover",
      "label": "Open slides on hover",
      "info": "When enabled, hovering or focusing a spine opens its panel.",
      "default": false
    },
    {
      "type": "header",
      "content": "Footer"
    },
    {
      "type": "richtext",
      "id": "footer_text",
      "label": "Footer text"
    },
    {
      "type": "text",
      "id": "footer_link_label",
      "label": "Footer link label"
    },
    {
      "type": "url",
      "id": "footer_link_url",
      "label": "Footer link"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "text",
          "id": "spine_heading",
          "label": "Spine heading",
          "default": "Commercial Bay"
        },
        {
          "type": "color_scheme",
          "id": "color_scheme",
          "label": "Slide color scheme",
          "info": "Applies to the spine and the expanded panel."
        },
        {
          "type": "select",
          "id": "spine_text_style",
          "label": "Spine text style",
          "options": [
            {
              "value": "paragraph",
              "label": "Paragraph"
            },
            {
              "value": "h1",
              "label": "Heading 1"
            },
            {
              "value": "h2",
              "label": "Heading 2"
            },
            {
              "value": "h3",
              "label": "Heading 3"
            },
            {
              "value": "h4",
              "label": "Heading 4"
            },
            {
              "value": "h5",
              "label": "Heading 5"
            },
            {
              "value": "h6",
              "label": "Heading 6"
            },
            {
              "value": "overline",
              "label": "Overline"
            }
          ],
          "default": "h3"
        },
        {
          "type": "select",
          "id": "spine_alignment",
          "label": "Spine text alignment",
          "info": "Controls how the text sits within the spine.",
          "options": [
            {
              "value": "start",
              "label": "Top / Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "end",
              "label": "Bottom / Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "range",
          "id": "spine_padding_block",
          "label": "Spine padding (vertical)",
          "min": 8,
          "max": 72,
          "step": 2,
          "unit": "px",
          "default": 32
        },
        {
          "type": "range",
          "id": "spine_padding_inline",
          "label": "Spine padding (horizontal)",
          "min": 4,
          "max": 40,
          "step": 2,
          "unit": "px",
          "default": 16
        },
        {
          "type": "text",
          "id": "eyebrow",
          "label": "Eyebrow label"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Panel heading",
          "default": "9 Charles Street, Mount Eden, Auckland"
        },
        {
          "type": "textarea",
          "id": "summary",
          "label": "Summary"
        },
        {
          "type": "richtext",
          "id": "body",
          "label": "Body content"
        },
        {
          "type": "richtext",
          "id": "details",
          "label": "Details",
          "info": "Use for hours, addresses, or additional CTAs."
        },
        {
          "type": "select",
          "id": "media_type",
          "label": "Media type",
          "options": [
            {
              "value": "image",
              "label": "Image"
            },
            {
              "value": "uploaded_video",
              "label": "Uploaded video"
            },
            {
              "value": "external_video",
              "label": "External video"
            },
            {
              "value": "none",
              "label": "None"
            }
          ],
          "default": "image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "visible_if": "{{ block.settings.media_type == 'image' }}"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "visible_if": "{{ block.settings.media_type == 'uploaded_video' }}"
        },
        {
          "type": "video_url",
          "id": "video_url",
          "label": "External video URL",
          "accept": [
            "youtube",
            "vimeo"
          ],
          "visible_if": "{{ block.settings.media_type == 'external_video' }}"
        },
        {
          "type": "image_picker",
          "id": "video_poster",
          "label": "Poster image",
          "visible_if": "{{ block.settings.media_type == 'external_video' }}"
        },
        {
          "type": "checkbox",
          "id": "video_autoplay",
          "label": "Autoplay video",
          "default": true,
          "visible_if": "{{ block.settings.media_type != 'image' and block.settings.media_type != 'none' }}"
        },
        {
          "type": "checkbox",
          "id": "video_loop",
          "label": "Loop video",
          "default": true,
          "visible_if": "{{ block.settings.media_type != 'image' and block.settings.media_type != 'none' }}"
        },
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Panel icon"
        },
        {
          "type": "text",
          "id": "icon_alt",
          "label": "Icon alt text"
        },
        {
          "type": "text",
          "id": "cta_label",
          "label": "Button label"
        },
        {
          "type": "url",
          "id": "cta_url",
          "label": "Button link"
        }
      ]
    }
  ],
  "max_blocks": 9,
  "presets": [
    {
      "name": "Dynamic Carousel",
      "category": "Content",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "spine_heading": "Commercial Bay"
          }
        },
        {
          "type": "slide",
          "settings": {
            "spine_heading": "Roastery Roller Door"
          }
        },
        {
          "type": "slide",
          "settings": {
            "spine_heading": "Wholesale HQ"
          }
        }
      ]
    }
  ]
}
{% endschema %}

{% javascript %}
  (() => {
    const sectionId = 'shopify-section-{{ section.id }}';

    class DynamicCarousel {
      constructor(stage) {
        this.stage = stage;
        this.handles = Array.from(stage.querySelectorAll('[data-dynamic-carousel-handle]'));
        this.panels = Array.from(stage.querySelectorAll('[data-dynamic-carousel-panel]'));
        this.activeIndex = this.handles.findIndex((handle) => handle.getAttribute('aria-selected') === 'true');
        this.interactionMode = stage.dataset.interactionMode === 'hover' ? 'hover' : 'click';
        this.listeners = [];

        if (this.handles.length === 0 || this.panels.length === 0) {
          return;
        }

        if (this.activeIndex < 0) {
          this.activeIndex = 0;
          this.updateState(this.activeIndex, false);
        }

        this.handles.forEach((handle, index) => {
          const handleListeners = {
            click: () => this.updateState(index, false),
            keydown: (event) => this.onKeydown(event, index),
          };

          handle.addEventListener('click', handleListeners.click);
          handle.addEventListener('keydown', handleListeners.keydown);

          if (this.interactionMode === 'hover') {
            handleListeners.pointerenter = () => this.updateState(index, false);
            handleListeners.focus = () => this.updateState(index, false);
            handle.addEventListener('pointerenter', handleListeners.pointerenter);
            handle.addEventListener('focus', handleListeners.focus);
          }

          this.listeners.push({ handle, handleListeners });
        });
      }

      onKeydown(event, index) {
        const keys = ['ArrowLeft', 'ArrowRight', 'Home', 'End'];

        if (!keys.includes(event.key)) {
          return;
        }

        event.preventDefault();

        let nextIndex = index;

        switch (event.key) {
          case 'ArrowLeft':
            nextIndex = (index - 1 + this.handles.length) % this.handles.length;
            break;
          case 'ArrowRight':
            nextIndex = (index + 1) % this.handles.length;
            break;
          case 'Home':
            nextIndex = 0;
            break;
          case 'End':
            nextIndex = this.handles.length - 1;
            break;
        }

        this.updateState(nextIndex, true);
      }

      updateState(targetIndex, focusHandle) {
        if (targetIndex === this.activeIndex) {
          if (focusHandle) {
            this.handles[targetIndex]?.focus();
          }
          return;
        }

        this.handles.forEach((handle, index) => {
          const isActive = index === targetIndex;
          handle.setAttribute('aria-selected', isActive ? 'true' : 'false');
          handle.setAttribute('aria-expanded', isActive ? 'true' : 'false');
          handle.setAttribute('tabindex', isActive ? '0' : '-1');
          handle.classList.toggle('is-active', isActive);

          if (isActive && focusHandle) {
            handle.focus();
          }
        });

        this.panels.forEach((panel, index) => {
          const isActive = index === targetIndex;

          panel.classList.toggle('is-active', isActive);
          panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');

          if (isActive) {
            panel.removeAttribute('hidden');
          } else {
            panel.setAttribute('hidden', '');
          }
        });

        this.activeIndex = targetIndex;
      }

      destroy() {
        this.listeners.forEach(({ handle, handleListeners }) => {
          handle.removeEventListener('click', handleListeners.click);
          handle.removeEventListener('keydown', handleListeners.keydown);

          if (handleListeners.pointerenter) {
            handle.removeEventListener('pointerenter', handleListeners.pointerenter);
          }

          if (handleListeners.focus) {
            handle.removeEventListener('focus', handleListeners.focus);
          }
        });

        this.listeners = [];
      }
    }

    const hydrate = (sectionEl) => {
      if (!(sectionEl instanceof HTMLElement)) {
        return null;
      }

      const stage = sectionEl.querySelector('[data-dynamic-carousel-stage]');

      if (!stage) {
        return null;
      }

      return new DynamicCarousel(stage);
    };

    let instance = hydrate(document.getElementById(sectionId));

    document.addEventListener('shopify:section:load', (event) => {
      if (event.target?.id !== sectionId) {
        return;
      }

      if (instance) {
        instance.destroy();
      }

      instance = hydrate(event.target);
    });

    document.addEventListener('shopify:section:unload', (event) => {
      if (event.target?.id !== sectionId) {
        return;
      }

      if (instance) {
        instance.destroy();
        instance = null;
      }
    });
  })();
{% endjavascript %}
