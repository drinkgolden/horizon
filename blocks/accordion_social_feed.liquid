{% assign block_settings = block.settings %}
{% assign slide_count = block_settings.max_items | default: 12 | times: 1 %}
{% assign slideshow_ref = 'socialFeed' | append: block.id %}
{% assign section_width_setting = section.settings.section_width | default: 'full-width' %}
{% assign slideshow_gutters = nil %}
{% if section_width_setting == 'page-width' %}
  {% assign slideshow_gutters = 'start end' %}
{% endif %}

{% capture slides %}
  {% for i in (1..slide_count) %}
    {% capture slide_markup %}
      <div class="resource-list__item social-feed__item" data-social-feed-item data-index="{{ forloop.index0 }}">
        <a class="social-feed-card" data-social-feed-link href="#" aria-label="Social post">
          <div class="social-feed-card__media border-style">
            {{ 'hero-apparel-2' | placeholder_svg_tag: 'social-feed-card__placeholder' }}
            <img
              class="social-feed-card__image"
              data-social-feed-image
              loading="lazy"
              decoding="async"
              alt="Social post"
            >
          </div>
          <div class="social-feed-card__caption" data-social-feed-caption></div>
        </a>
      </div>
    {% endcapture %}
    {% render 'slideshow-slide',
      index: forloop.index0,
      children: slide_markup,
      class: 'resource-list__slide'
    %}
  {% endfor %}
{% endcapture %}

{% if block_settings.icons_style != 'none' %}
  {% capture slideshow_arrows %}
    {% render 'slideshow-arrows',
      icon_style: block_settings.icons_style,
      icon_shape: block_settings.icons_shape
    %}
  {% endcapture %}
{% endif %}

<div
  class="accordion-social-feed"
  data-social-feed
  data-provider="{{ block_settings.provider }}"
  data-feed-url="{{ block_settings.feed_url | escape }}"
  data-limit="{{ slide_count }}"
  data-show-captions="{{ block_settings.show_captions }}"
  data-open-new-tab="{{ block_settings.open_new_tab }}"
  data-image-ratio="{{ block_settings.image_ratio }}"
>
  <div
    class="resource-list resource-list__carousel force-full-width"
    style="
      --resource-list-column-gap-desktop: {{ block_settings.columns_gap }}px;
      --column-count: {{ block_settings.columns }};
      --column-count-mobile: 1;
      --mobile-card-size: {{ block_settings.mobile_card_size }};
      --slide-width-max: {{ block_settings.slide_width_max }}px;
    "
  >
    {% render 'slideshow',
      ref: slideshow_ref,
      class: 'resource-list__carousel',
      slides: slides,
      slideshow_arrows: slideshow_arrows,
      auto_hide_controls: false,
      infinite: false,
      initial_slide: 0,
      slide_count: slide_count,
      slideshow_gutters: slideshow_gutters
    %}
  </div>
</div>

{% stylesheet %}
  .accordion-social-feed {
    --social-feed-aspect-ratio: 1 / 1;
  }

  .accordion-social-feed[data-image-ratio='portrait'] {
    --social-feed-aspect-ratio: 4 / 5;
  }

  .accordion-social-feed[data-image-ratio='landscape'] {
    --social-feed-aspect-ratio: 16 / 9;
  }

  .accordion-social-feed .resource-list__carousel {
    width: 100%;
  }

  .social-feed__item {
    height: 100%;
  }

  .social-feed-card {
    display: flex;
    flex-direction: column;
    gap: var(--margin-xs);
    text-decoration: none;
    color: inherit;
  }

  .social-feed-card__media {
    position: relative;
    width: 100%;
    overflow: hidden;
    aspect-ratio: var(--social-feed-aspect-ratio);
    background: rgb(var(--color-foreground-rgb, 0 0 0) / 0.04);
  }

  .social-feed-card__image,
  .social-feed-card__placeholder {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .social-feed-card__placeholder {
    position: absolute;
    inset: 0;
    padding: var(--padding-xs);
  }

  .social-feed__item--loaded .social-feed-card__placeholder {
    opacity: 0;
    visibility: hidden;
  }

  .social-feed-card__caption {
    font-size: var(--font-body--size);
    line-height: var(--font-body--line-height);
    color: inherit;
  }

  .accordion-social-feed[data-show-captions='false'] .social-feed-card__caption {
    display: none;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Social feed row",
  "tag": null,
  "settings": [
    {
      "type": "select",
      "id": "provider",
      "label": "Provider",
      "options": [
        { "value": "instagram", "label": "Instagram" },
        { "value": "tiktok", "label": "TikTok" }
      ],
      "default": "instagram"
    },
    {
      "type": "text",
      "id": "feed_url",
      "label": "Feed URL",
      "info": "Leave blank to use /apps/golden-feed/app_proxy/{provider}."
    },
    {
      "type": "range",
      "id": "max_items",
      "label": "Max items",
      "min": 3,
      "max": 20,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "show_captions",
      "label": "Show captions",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "open_new_tab",
      "label": "Open posts in new tab",
      "default": true
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image ratio",
      "options": [
        { "value": "square", "label": "Square" },
        { "value": "portrait", "label": "Portrait" },
        { "value": "landscape", "label": "Landscape" }
      ],
      "default": "square"
    },
    {
      "type": "header",
      "content": "Carousel layout"
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Column gap",
      "min": 0,
      "max": 40,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "select",
      "id": "mobile_card_size",
      "label": "Mobile card size",
      "options": [
        { "value": "50cqw", "label": "Small" },
        { "value": "60cqw", "label": "Medium" },
        { "value": "75cqw", "label": "Large" }
      ],
      "default": "60cqw"
    },
    {
      "type": "range",
      "id": "slide_width_max",
      "label": "Max slide width",
      "min": 240,
      "max": 520,
      "step": 10,
      "unit": "px",
      "default": 420
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow style",
      "options": [
        { "value": "arrow", "label": "Arrow" },
        { "value": "caret", "label": "Caret" },
        { "value": "none", "label": "None" }
      ],
      "default": "arrow"
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow shape",
      "options": [
        { "value": "circle", "label": "Circle" },
        { "value": "square", "label": "Square" },
        { "value": "none", "label": "None" }
      ],
      "default": "circle"
    }
  ],
  "presets": [
    {
      "name": "Social feed row",
      "settings": {
        "provider": "instagram",
        "show_captions": false,
        "columns": 4,
        "columns_gap": 12,
        "mobile_card_size": "60cqw",
        "icons_style": "arrow",
        "icons_shape": "circle"
      }
    }
  ]
}
{% endschema %}
